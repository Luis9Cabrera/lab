---
import Layout from "../layouts/Layout.astro";
import { studies } from "../data/studies";
import { Search, Filter, ArrowLeft, Info } from "lucide-astro";
import Modal from "../components/Modal.astro";

const categories = ["Todos", "Rutina", "Hormonal", "Preventivo", "Especial"];
---

<Layout title="Catálogo de Estudios | Venecia Laboratorio Clínico">
  <main class="pt-32 pb-24 bg-surface min-h-screen">
    <div class="container mx-auto px-6">
      <!-- Header -->
      <div
        class="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 gap-6"
      >
        <div>
          <h1 class="text-4xl md:text-5xl font-black text-primary">
            Catálogo de Estudios
          </h1>
          <p class="text-slate-600 mt-2">
            Encuentra información detallada y preparaciones para tus análisis.
          </p>
        </div>
      </div>

      <!-- Search and Filter Bar -->
      <div class="flex flex-col lg:flex-row gap-6 mb-12">
        <div class="flex-1 relative">
          <Search
            class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"
          />
          <input
            type="text"
            id="studySearch"
            placeholder="Buscar por nombre de estudio..."
            class="w-full pl-12 pr-6 py-4 rounded-2xl bg-white border border-slate-200 focus:outline-none focus:ring-2 focus:ring-secondary/20 focus:border-secondary shadow-sm transition-all"
          />
        </div>
        <div class="flex gap-2 overflow-x-auto pb-2 lg:pb-0 scrollbar-hide">
          {
            categories.map((cat) => (
              <button
                class={`category-btn px-6 py-4 rounded-2xl font-bold transition-all whitespace-nowrap border ${cat === "Todos" ? "bg-primary text-white border-primary shadow-lg" : "bg-white text-slate-600 border-slate-200 hover:border-secondary hover:text-secondary"}`}
                data-category={cat}
              >
                {cat}
              </button>
            ))
          }
        </div>
      </div>

      <!-- Studies Grid -->
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8" id="studiesGrid">
        {
          studies.map((study) => (
            <div
              class="study-card group relative bg-white p-8 rounded-[2.5rem] border border-slate-100 hover:border-secondary/30 shadow-sm hover:shadow-2xl hover:-translate-y-2 transition-all duration-500"
              data-category={study.category}
              data-name={study.name.toLowerCase()}
            >
              <div class="flex justify-between items-start mb-6">
                <div class="p-4 bg-secondary/10 rounded-2xl text-secondary group-hover:bg-secondary group-hover:text-white transition-all duration-500">
                  <study.icon class="w-7 h-7" />
                </div>
                <span class="px-3 py-1 bg-slate-100 text-slate-500 rounded-full text-xs font-bold uppercase tracking-wider">
                  {study.category}
                </span>
              </div>

              <h3 class="text-2xl font-bold text-primary mb-3 group-hover:text-secondary transition-colors">
                {study.name}
              </h3>
              <p class="text-slate-500 mb-8 line-clamp-2">{study.desc}</p>

              <button
                class="open-modal-trigger w-full py-4 bg-slate-50 hover:bg-primary text-primary hover:text-white rounded-2xl font-bold transition-all flex items-center justify-center gap-2 group/btn"
                data-study={JSON.stringify(study)}
              >
                Ver información completa
                <Info class="w-5 h-5 opacity-50 group-hover/btn:opacity-100 transition-opacity" />
              </button>
            </div>
          ))
        }
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="hidden text-center py-20">
        <div
          class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6"
        >
          <Search class="w-10 h-10 text-slate-400" />
        </div>
        <h3 class="text-2xl font-bold text-primary">No encontramos estudios</h3>
        <p class="text-slate-500">Prueba con otro término o categoría.</p>
      </div>
    </div>
  </main>

  <Modal />
</Layout>

<script>
  // Filters and Search logic
  const searchInput = document.getElementById(
    "studySearch",
  ) as HTMLInputElement;
  const categoryBtns = document.querySelectorAll(".category-btn");
  const studyCards = document.querySelectorAll(".study-card");
  const emptyState = document.getElementById("emptyState");

  let currentFilter = "Todos";
  let searchTerm = "";

  function filterStudies() {
    let visibleCount = 0;
    studyCards.forEach((card) => {
      const element = card as HTMLElement;
      const category = element.dataset.category || "";
      const name = element.dataset.name || "";

      const matchesFilter =
        currentFilter === "Todos" || category === currentFilter;
      const matchesSearch = name.includes(searchTerm);

      if (matchesFilter && matchesSearch) {
        element.style.display = "block";
        visibleCount++;
      } else {
        element.style.display = "none";
      }
    });

    if (visibleCount === 0) {
      emptyState?.classList.remove("hidden");
    } else {
      emptyState?.classList.add("hidden");
    }
  }

  searchInput?.addEventListener("input", (e) => {
    searchTerm = (e.target as HTMLInputElement).value.toLowerCase();
    filterStudies();
  });

  categoryBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      categoryBtns.forEach((b) => {
        b.classList.remove(
          "bg-primary",
          "text-white",
          "border-primary",
          "shadow-lg",
        );
        b.classList.add("bg-white", "text-slate-600", "border-slate-200");
      });
      btn.classList.add(
        "bg-primary",
        "text-white",
        "border-primary",
        "shadow-lg",
      );
      btn.classList.remove("bg-white", "text-slate-600", "border-slate-200");

      currentFilter = (btn as HTMLElement).dataset.category || "Todos";
      filterStudies();
    });
  });
</script>

<style>
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
